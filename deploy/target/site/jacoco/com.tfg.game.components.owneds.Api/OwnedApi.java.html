<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OwnedApi.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Card Game Exam</a> &gt; <a href="index.source.html" class="el_package">com.tfg.game.components.owneds.Api</a> &gt; <span class="el_source">OwnedApi.java</span></div><h1>OwnedApi.java</h1><pre class="source lang-java linenums">package com.tfg.game.components.owneds.Api;


import com.tfg.game.components.dices.DicesController;
import com.tfg.game.components.elements.ElementsController;
import com.tfg.game.components.owneds.OwnedsController;
import com.tfg.game.components.partnerships.PartnershipController;
import com.tfg.game.components.resources.ResourcesController;
import com.tfg.game.components.typeds.TypedsController;
import com.tfg.game.components.upgradeds.UpgradedsController;
import com.tfg.game.ecs.GameData;
import com.tfg.game.games.GamesController;
import com.tfg.game.games.api.GamesApi;
import com.tfg.game.players.PlayersController;
import org.springframework.web.bind.annotation.*;


@RestController
@RequestMapping(&quot;api/v1/owned&quot;)
public class OwnedApi {
    private final OwnedsController ownedsController;
    private final PlayersController playersController;
    private final ResourcesController resourcesController;
    private final TypedsController typedsController;
    private final UpgradedsController upgradedsController;
    private final PartnershipController partnershipController;
    private final ElementsController elementsController;
    private final DicesController dicesController;
    private final GamesController gamesController;

    private final GamesApi gamesApi;

<span class="fc" id="L33">    public OwnedApi(OwnedsController ownedsController, PlayersController playersController, ResourcesController resourcesController, TypedsController typedsController, UpgradedsController upgradedsController, PartnershipController partnershipController, ElementsController elementsController, DicesController dicesController, GamesController gamesController, GamesApi gamesApi) {</span>
<span class="fc" id="L34">        this.ownedsController = ownedsController;</span>
<span class="fc" id="L35">        this.playersController = playersController;</span>
<span class="fc" id="L36">        this.resourcesController = resourcesController;</span>
<span class="fc" id="L37">        this.typedsController = typedsController;</span>
<span class="fc" id="L38">        this.upgradedsController = upgradedsController;</span>
<span class="fc" id="L39">        this.partnershipController = partnershipController;</span>
<span class="fc" id="L40">        this.elementsController = elementsController;</span>
<span class="fc" id="L41">        this.dicesController = dicesController;</span>
<span class="fc" id="L42">        this.gamesController = gamesController;</span>
<span class="fc" id="L43">        this.gamesApi = gamesApi;</span>
<span class="fc" id="L44">    }</span>

    @PostMapping(&quot;{entityId}/{playerName}/own&quot;)
    public GameData Own(@PathVariable String entityId, @PathVariable String playerName, @RequestParam String token){
<span class="fc" id="L48">        var player = playersController.findPlayer(playerName).get();</span>

<span class="fc" id="L50">        var ownedTest = ownedsController.own(entityId);</span>

<span class="fc" id="L52">        var isCurrentPlayerTurn = gamesController.isCurrentPlayerTurn(ownedTest.getGame(), player);</span>

<span class="fc bfc" id="L54" title="All 2 branches covered.">        if(isCurrentPlayerTurn) {</span>
<span class="fc" id="L55">            var inventoryId = ownedsController.findAllByGameAndOwner(ownedTest.getGame(), player).stream()</span>
<span class="fc" id="L56">                    .filter(c -&gt; typedsController.isTyped(c.getEntityId(), &quot;inventory&quot;)).findFirst().get().getEntityId();</span>

<span class="fc" id="L58">            var isVertex = typedsController.isTyped(entityId, &quot;vertex&quot;);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">            var isOwned = ownedTest.getOwner() != null ? true : false;</span>

<span class="fc" id="L61">            var partnership = partnershipController.getPartnership(entityId);</span>
<span class="pc bpc" id="L62" title="3 of 4 branches missed.">            var isOwnedNeighbour1BySamePlayer = ownedsController.own(partnership.getPartnership1()).getOwner() == null ? false : ownedsController.own(partnership.getPartnership1()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L63" title="3 of 4 branches missed.">            var isOwnedNeighbour2BySamePlayer = ownedsController.own(partnership.getPartnership2()).getOwner() == null ? false : ownedsController.own(partnership.getPartnership2()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L64" title="4 of 6 branches missed.">            var isOwnedNeighbour3BySamePlayer = partnership.getPartnership3() == &quot;&quot; ? null : ownedsController.own(partnership.getPartnership3()).getOwner() == null ? false : ownedsController.own(partnership.getPartnership3()).getOwner().getPlayerName() == playerName ? true : false;</span>

<span class="fc" id="L66">            var partner1Partnership = partnershipController.getPartnership(partnership.getPartnership1());</span>
<span class="fc" id="L67">            var partner2Partnership = partnershipController.getPartnership(partnership.getPartnership2());</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">            var partner3Partnership = isOwnedNeighbour3BySamePlayer == null ? null : partnershipController.getPartnership(partnership.getPartnership3());</span>

<span class="pc bpc" id="L70" title="2 of 4 branches missed.">            var isOwnedNeighbour3BySamePlayerSave = isOwnedNeighbour3BySamePlayer == null ? false : isOwnedNeighbour3BySamePlayer == true ? true : false;</span>
            //needed for vertex bussiness rules
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">            var isOwnedNeighbour1Vertex1 = ownedsController.own(partner1Partnership.getPartnership1()).getOwner() != null ? true : false;</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            var isOwnedNeighbour1Vertex2 = ownedsController.own(partner1Partnership.getPartnership2()).getOwner() != null ? true : false;</span>

<span class="pc bpc" id="L75" title="1 of 2 branches missed.">            var isOwnedNeighbour2Vertex1 = ownedsController.own(partner2Partnership.getPartnership1()).getOwner() != null ? true : false;</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">            var isOwnedNeighbour2Vertex2 = ownedsController.own(partner2Partnership.getPartnership2()).getOwner() != null ? true : false;</span>

<span class="fc" id="L78">            var isOwnedNeighbour3Vertex1 = false;</span>
<span class="fc" id="L79">            var isOwnedNeighbour3Vertex2 = false;</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">            if (partner3Partnership != null) {</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">                isOwnedNeighbour3Vertex1 = ownedsController.own(partner3Partnership.getPartnership1()).getOwner() != null ? true : false;</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">                isOwnedNeighbour3Vertex2 = ownedsController.own(partner3Partnership.getPartnership2()).getOwner() != null ? true : false;</span>
            }


            //needed for road bussiness rules
<span class="pc bpc" id="L87" title="3 of 4 branches missed.">            var isOwnedPartner1Neighbour1BySamePlayer = ownedsController.own(partner1Partnership.getPartnership1()).getOwner() == null ? false : ownedsController.own(partner1Partnership.getPartnership1()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L88" title="3 of 4 branches missed.">            var isOwnedPartner1Neighbour2BySamePlayer = ownedsController.own(partner1Partnership.getPartnership2()).getOwner() == null ? false : ownedsController.own(partner1Partnership.getPartnership2()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L89" title="7 of 8 branches missed.">            var isOwnedPartner1Neighbour3BySamePlayer = partner1Partnership.getPartnership3() == &quot;&quot; ? false : ownedsController.own(partner1Partnership.getPartnership3()) == null ? false : ownedsController.own(partner1Partnership.getPartnership3()).getOwner() == null ? false : ownedsController.own(partner1Partnership.getPartnership3()).getOwner().getPlayerName() == playerName ? true : false;</span>

<span class="pc bpc" id="L91" title="3 of 4 branches missed.">            var isOwnedPartner2Neighbour1BySamePlayer = ownedsController.own(partner2Partnership.getPartnership1()).getOwner() == null ? false : ownedsController.own(partner2Partnership.getPartnership1()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L92" title="3 of 4 branches missed.">            var isOwnedPartner2Neighbour2BySamePlayer = ownedsController.own(partner2Partnership.getPartnership2()).getOwner() == null ? false : ownedsController.own(partner2Partnership.getPartnership2()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L93" title="5 of 6 branches missed.">            var isOwnedPartner2Neighbour3BySamePlayer = partner2Partnership.getPartnership3() == &quot;&quot; ? false : ownedsController.own(partner2Partnership.getPartnership3()).getOwner() == null ? false : ownedsController.own(partner2Partnership.getPartnership3()).getOwner().getPlayerName() == playerName ? true : false;</span>

<span class="fc" id="L95">            var isOwnedPartner3Neighbour1BySamePlayer = false;</span>
<span class="fc" id="L96">            var isOwnedPartner3Neighbour2BySamePlayer = false;</span>
<span class="fc" id="L97">            var isOwnedPartner3Neighbour3BySamePlayer = false;</span>

<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            if (partner3Partnership != null) {</span>
<span class="pc bpc" id="L100" title="3 of 4 branches missed.">                isOwnedPartner3Neighbour1BySamePlayer = ownedsController.own(partner3Partnership.getPartnership1()).getOwner() == null ? false : ownedsController.own(partner3Partnership.getPartnership1()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L101" title="3 of 4 branches missed.">                isOwnedPartner3Neighbour2BySamePlayer = ownedsController.own(partner3Partnership.getPartnership2()).getOwner() == null ? false : ownedsController.own(partner3Partnership.getPartnership2()).getOwner().getPlayerName() == playerName ? true : false;</span>
<span class="pc bpc" id="L102" title="5 of 6 branches missed.">                isOwnedPartner3Neighbour3BySamePlayer = partner3Partnership.getPartnership3() == &quot;&quot; ? false : ownedsController.own(partner3Partnership.getPartnership3()).getOwner() == null ? false : ownedsController.own(partner3Partnership.getPartnership3()).getOwner().getPlayerName() == playerName ? true : false;</span>
            }

<span class="fc" id="L105">            var howManyVertexOwnedByPlayer = ownedsController.findAllByGameAndOwner(ownedTest.getGame(), player).stream()</span>
<span class="fc" id="L106">                    .filter(c -&gt; typedsController.isTyped(c.getEntityId(), &quot;vertex&quot;)).count();</span>

            boolean resources;
            boolean elements;
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">            if (isVertex) {</span>

<span class="pc bpc" id="L112" title="1 of 2 branches missed.">                if (!isOwned) {</span>
<span class="pc bpc" id="L113" title="22 of 32 branches missed.">                    if (((isOwnedNeighbour1BySamePlayer || isOwnedNeighbour2BySamePlayer || isOwnedNeighbour3BySamePlayerSave) &amp;&amp;</span>
                            (!isOwnedNeighbour1Vertex1 &amp;&amp; !isOwnedNeighbour1Vertex2 &amp;&amp; !isOwnedNeighbour2Vertex1 &amp;&amp; !isOwnedNeighbour2Vertex2 &amp;&amp; !isOwnedNeighbour3Vertex1 &amp;&amp; !isOwnedNeighbour3Vertex2)) ||
                            (howManyVertexOwnedByPlayer &lt; 2 &amp;&amp; (!isOwnedNeighbour1Vertex1 &amp;&amp; !isOwnedNeighbour1Vertex2 &amp;&amp; !isOwnedNeighbour2Vertex1 &amp;&amp; !isOwnedNeighbour2Vertex2 &amp;&amp; !isOwnedNeighbour3Vertex1 &amp;&amp; !isOwnedNeighbour3Vertex2))) {
<span class="fc" id="L116">                        resources = resourcesController.ownTown(inventoryId, true);</span>
                    } else {
<span class="nc" id="L118">                        resources = resourcesController.ownTown(inventoryId, false);</span>
                    }
<span class="fc" id="L120">                    elements = elementsController.ownTown(inventoryId, resources);</span>
                } else {
<span class="nc bnc" id="L122" title="All 2 branches missed.">                    var isDifferentPlayer = ownedTest.getOwner().getPlayerName() != playerName ? true : false;</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">                    if (isDifferentPlayer) {</span>
<span class="nc" id="L125">                        resources = resourcesController.ownCity(inventoryId, false);</span>
                    } else {
<span class="nc" id="L127">                        resources = resourcesController.ownCity(inventoryId, true);</span>
                    }
<span class="nc" id="L129">                    elements = elementsController.ownCity(inventoryId, resources);</span>

<span class="nc" id="L131">                }</span>
            } else {
<span class="nc bnc" id="L133" title="All 2 branches missed.">                if (isOwned)</span>
<span class="nc" id="L134">                    resources = resourcesController.ownRoad(inventoryId, false);</span>
                else {
<span class="nc bnc" id="L136" title="All 16 branches missed.">                    if ((isOwnedNeighbour1BySamePlayer || isOwnedNeighbour2BySamePlayer) ||</span>
                            (isOwnedPartner1Neighbour1BySamePlayer || isOwnedPartner1Neighbour2BySamePlayer || isOwnedPartner1Neighbour3BySamePlayer) ||
                            (isOwnedPartner2Neighbour1BySamePlayer || isOwnedPartner2Neighbour2BySamePlayer || isOwnedPartner2Neighbour3BySamePlayer))
<span class="nc" id="L139">                        resources = resourcesController.ownRoad(inventoryId, true);</span>
                    else
<span class="nc" id="L141">                        resources = resourcesController.ownRoad(inventoryId, false);</span>

                }
<span class="nc" id="L144">                elements = elementsController.ownRoad(inventoryId, resources);</span>
            }
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">            if (elements) {</span>
<span class="pc bpc" id="L147" title="2 of 4 branches missed.">                if (isVertex &amp;&amp; isOwned) {</span>
<span class="nc" id="L148">                    var upgraded = upgradedsController.upgrade(entityId, true);</span>
<span class="nc" id="L149">                    var game = upgraded.getGame();</span>
<span class="nc" id="L150">                    return gamesApi.get(game.getGameName(), game.getCreator().getPlayerName(), token);</span>

                } else {
<span class="fc" id="L153">                    var owned = ownedsController.own(entityId, player);</span>
<span class="fc" id="L154">                    var game = owned.getGame();</span>
<span class="fc" id="L155">                    return gamesApi.get(game.getGameName(), game.getCreator().getPlayerName(), token);</span>
                }
            }
        }
<span class="fc" id="L159">        var owned = ownedsController.own(entityId);</span>
<span class="fc" id="L160">        var game = owned.getGame();</span>

<span class="fc" id="L162">        return gamesApi.get(game.getGameName(), game.getCreator().getPlayerName(), token);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>